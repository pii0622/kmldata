<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>地図アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

<!-- Header buttons -->
<div class="header-buttons">
  <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="メニュー">
    <i class="fas fa-bars"></i>
  </button>
  <button class="map-btn" onclick="zoomToMyLocation()" title="現在地にズーム">
    <i class="fas fa-location-crosshairs"></i> 現在地
  </button>
  <button class="map-btn" id="btn-add-pin" onclick="startPinMode()" title="ピンを追加" style="display:none;">
    <i class="fas fa-map-pin"></i> ピン追加
  </button>
</div>

<div id="map"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2><i class="fas fa-map"></i> 地図アプリ</h2>
    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
  </div>
  <div class="sidebar-content" id="sidebar-content">
    <!-- Dynamic content -->
  </div>
</div>

<!-- Pin creation modal -->
<div class="modal-overlay" id="modal-pin">
  <div class="modal">
    <h3><i class="fas fa-map-pin"></i> ピンを作成</h3>
    <div class="form-group">
      <label>タイトル *</label>
      <input type="text" id="pin-title" placeholder="ピンのタイトル">
    </div>
    <div class="form-group">
      <label>説明</label>
      <textarea id="pin-desc" placeholder="ピンの説明"></textarea>
    </div>
    <div class="form-group">
      <label>フォルダ</label>
      <select id="pin-folder"></select>
    </div>
    <div class="form-group">
      <label>画像を追加</label>
      <input type="file" id="pin-images" multiple accept="image/*" onchange="previewPinImages(this)">
      <div id="pin-image-preview" class="image-preview-container"></div>
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="pin-public"> 全ユーザーに公開する（管理者のみ）
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="cancelPinMode()">キャンセル</button>
      <button class="btn btn-primary" onclick="savePin()">作成</button>
    </div>
  </div>
</div>

<!-- Pin edit modal -->
<div class="modal-overlay" id="modal-pin-edit">
  <div class="modal">
    <h3><i class="fas fa-edit"></i> ピンを編集</h3>
    <div class="form-group">
      <label>タイトル *</label>
      <input type="text" id="edit-pin-title">
    </div>
    <div class="form-group">
      <label>説明</label>
      <textarea id="edit-pin-desc"></textarea>
    </div>
    <div class="form-group">
      <label>フォルダ</label>
      <select id="edit-pin-folder"></select>
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="edit-pin-public"> 全ユーザーに公開する（管理者のみ）
      </label>
    </div>
    <div class="form-group">
      <label>画像を追加</label>
      <input type="file" id="edit-pin-images" multiple accept="image/*">
    </div>
    <div id="edit-pin-current-images" class="pin-images"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeEditPin()">キャンセル</button>
      <button class="btn btn-primary" onclick="updatePin()">更新</button>
    </div>
  </div>
</div>

<!-- Folder create modal -->
<div class="modal-overlay" id="modal-folder">
  <div class="modal">
    <h3><i class="fas fa-folder-plus"></i> ピンフォルダを作成</h3>
    <div class="form-group">
      <label>フォルダ名 *</label>
      <input type="text" id="folder-name" placeholder="フォルダ名">
    </div>
    <div class="form-group">
      <label>親フォルダ</label>
      <select id="folder-parent"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="createFolder()">作成</button>
    </div>
  </div>
</div>

<!-- KML folder create modal -->
<div class="modal-overlay" id="modal-kml-folder">
  <div class="modal">
    <h3><i class="fas fa-folder-plus"></i> KMLフォルダを作成</h3>
    <div class="form-group">
      <label>フォルダ名 *</label>
      <input type="text" id="kml-folder-name" placeholder="フォルダ名">
    </div>
    <div class="form-group">
      <label>親フォルダ</label>
      <select id="kml-folder-parent"></select>
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="kml-folder-public"> 全ユーザーに公開する（管理者のみ）
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-kml-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="createKmlFolder()">作成</button>
    </div>
  </div>
</div>

<!-- KML upload modal -->
<div class="modal-overlay" id="modal-kml-upload">
  <div class="modal">
    <h3><i class="fas fa-upload"></i> KMLをアップロード</h3>
    <input type="hidden" id="kml-upload-folder-id">
    <div class="form-group">
      <label>KMLファイル *</label>
      <input type="file" id="kml-upload-file" accept=".kml,.kmz">
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="kml-upload-public"> 全ユーザーに公開する（管理者のみ）
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-kml-upload')">キャンセル</button>
      <button class="btn btn-primary" onclick="uploadKmlFile()">アップロード</button>
    </div>
  </div>
</div>

<!-- Rename KML folder modal -->
<div class="modal-overlay" id="modal-rename-kml-folder">
  <div class="modal">
    <h3><i class="fas fa-edit"></i> KMLフォルダ設定</h3>
    <input type="hidden" id="rename-kml-folder-id">
    <div class="form-group">
      <label>フォルダ名 *</label>
      <input type="text" id="rename-kml-folder-name" placeholder="フォルダ名">
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="rename-kml-folder-public"> 全ユーザーに公開する（管理者のみ）
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-rename-kml-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="renameKmlFolder()">変更</button>
    </div>
  </div>
</div>

<!-- Share KML folder modal -->
<div class="modal-overlay" id="modal-share-kml">
  <div class="modal">
    <h3><i class="fas fa-share-alt"></i> KMLフォルダを共有</h3>
    <input type="hidden" id="share-kml-folder-id">
    <div class="form-group">
      <input type="text" id="share-kml-search" placeholder="表示名で検索..." oninput="filterShareKmlUsers()">
    </div>
    <p style="font-size:13px;color:#666;margin-bottom:8px;">共有するユーザーを選択してください</p>
    <div class="user-select-list" id="share-kml-user-list">
      <!-- Dynamic user list -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-share-kml')">キャンセル</button>
      <button class="btn btn-primary" onclick="shareKmlFolder()">保存</button>
    </div>
  </div>
</div>

<!-- Rename pin folder modal -->
<div class="modal-overlay" id="modal-rename-folder">
  <div class="modal">
    <h3><i class="fas fa-edit"></i> ピンフォルダ設定</h3>
    <input type="hidden" id="rename-folder-id">
    <div class="form-group">
      <label>フォルダ名 *</label>
      <input type="text" id="rename-folder-name" placeholder="フォルダ名">
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="rename-folder-public"> 全ユーザーに公開する（管理者のみ）
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-rename-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="renameFolder()">変更</button>
    </div>
  </div>
</div>

<!-- Share pin folder modal -->
<div class="modal-overlay" id="modal-share-folder">
  <div class="modal">
    <h3><i class="fas fa-share-alt"></i> ピンフォルダを共有</h3>
    <input type="hidden" id="share-folder-id">
    <div class="form-group">
      <input type="text" id="share-folder-search" placeholder="表示名で検索..." oninput="filterShareFolderUsers()">
    </div>
    <p style="font-size:13px;color:#666;margin-bottom:8px;">共有するユーザーを選択してください</p>
    <div class="user-select-list" id="share-folder-user-list">
      <!-- Dynamic user list -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-share-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="shareFolder()">保存</button>
    </div>
  </div>
</div>

<!-- Move folder modal -->
<div class="modal-overlay" id="modal-move-folder">
  <div class="modal">
    <h3><i class="fas fa-arrows-alt"></i> フォルダを移動</h3>
    <input type="hidden" id="move-folder-id">
    <p style="font-size:14px;margin-bottom:12px;"><strong id="move-folder-name"></strong> を移動</p>
    <div class="form-group">
      <label>移動先フォルダ</label>
      <select id="move-folder-target"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-move-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="moveFolder()">移動</button>
    </div>
  </div>
</div>

<!-- Move pin modal -->
<div class="modal-overlay" id="modal-move-pin">
  <div class="modal">
    <h3><i class="fas fa-arrows-alt"></i> ピンを移動</h3>
    <input type="hidden" id="move-pin-id">
    <p style="font-size:14px;margin-bottom:12px;"><strong id="move-pin-name"></strong> を移動</p>
    <div class="form-group">
      <label>移動先フォルダ</label>
      <select id="move-pin-target"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-move-pin')">キャンセル</button>
      <button class="btn btn-primary" onclick="movePin()">移動</button>
    </div>
  </div>
</div>

<!-- Move KML file modal -->
<div class="modal-overlay" id="modal-move-kml-file">
  <div class="modal">
    <h3><i class="fas fa-arrows-alt"></i> KMLファイルを移動</h3>
    <input type="hidden" id="move-kml-file-id">
    <p style="font-size:14px;margin-bottom:12px;"><strong id="move-kml-file-name"></strong> を移動</p>
    <div class="form-group">
      <label>移動先フォルダ</label>
      <select id="move-kml-file-target"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-move-kml-file')">キャンセル</button>
      <button class="btn btn-primary" onclick="moveKmlFile()">移動</button>
    </div>
  </div>
</div>

<!-- Move KML folder modal -->
<div class="modal-overlay" id="modal-move-kml-folder">
  <div class="modal">
    <h3><i class="fas fa-arrows-alt"></i> KMLフォルダを移動</h3>
    <input type="hidden" id="move-kml-folder-id">
    <p style="font-size:14px;margin-bottom:12px;"><strong id="move-kml-folder-name"></strong> を移動</p>
    <div class="form-group">
      <label>移動先フォルダ</label>
      <select id="move-kml-folder-target"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-move-kml-folder')">キャンセル</button>
      <button class="btn btn-primary" onclick="moveKmlFolder()">移動</button>
    </div>
  </div>
</div>

<!-- Reorder KML folders modal -->
<div class="modal-overlay" id="modal-reorder-kml-folders">
  <div class="modal">
    <h3><i class="fas fa-sort"></i> KMLフォルダの並び替え</h3>
    <p style="font-size:13px;color:#666;margin-bottom:12px;">上下ボタンで順番を変更してください</p>
    <div id="reorder-kml-folder-list" class="reorder-list">
      <!-- Dynamic list -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="closeModal('modal-reorder-kml-folders')">完了</button>
    </div>
  </div>
</div>

<!-- Reorder pin folders modal -->
<div class="modal-overlay" id="modal-reorder-folders">
  <div class="modal">
    <h3><i class="fas fa-sort"></i> ピンフォルダの並び替え</h3>
    <p style="font-size:13px;color:#666;margin-bottom:12px;">上下ボタンで順番を変更してください</p>
    <div id="reorder-folder-list" class="reorder-list">
      <!-- Dynamic list -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="closeModal('modal-reorder-folders')">完了</button>
    </div>
  </div>
</div>

<!-- Auth modal -->
<div class="modal-overlay" id="modal-auth">
  <div class="modal">
    <h3 id="auth-title">ログイン</h3>
    <div class="form-group">
      <label>ユーザー名</label>
      <input type="text" id="auth-username" placeholder="ユーザー名">
    </div>
    <div class="form-group">
      <label>パスワード</label>
      <input type="password" id="auth-password" placeholder="パスワード">
    </div>
    <div class="form-group" id="auth-display-name-group" style="display:none;">
      <label>表示名</label>
      <input type="text" id="auth-display-name" placeholder="表示名（省略可）">
    </div>
    <div id="auth-error" style="color:#dc3545;font-size:13px;margin-bottom:8px;display:none;"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-auth')">キャンセル</button>
      <button class="btn btn-primary" id="auth-submit" onclick="submitAuth()">ログイン</button>
    </div>
    <p style="margin-top:12px;font-size:13px;text-align:center;">
      <a href="#" id="auth-toggle" onclick="toggleAuthMode(event)">アカウントを作成</a>
    </p>
  </div>
</div>

<!-- Account settings modal -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal">
    <h3><i class="fas fa-cog"></i> アカウント設定</h3>
    <div class="form-group">
      <label>表示名</label>
      <input type="text" id="settings-display-name" placeholder="表示名">
    </div>
    <div class="section-title" style="margin-top:16px;">パスワード変更</div>
    <div class="form-group">
      <label>現在のパスワード</label>
      <input type="password" id="settings-current-password" placeholder="現在のパスワード">
    </div>
    <div class="form-group">
      <label>新しいパスワード</label>
      <input type="password" id="settings-new-password" placeholder="新しいパスワード（4文字以上）">
    </div>
    <div class="form-group">
      <label>新しいパスワード（確認）</label>
      <input type="password" id="settings-confirm-password" placeholder="新しいパスワード（確認）">
    </div>
    <div id="settings-error" style="color:#dc3545;font-size:13px;margin-bottom:8px;display:none;"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-settings')">キャンセル</button>
      <button class="btn btn-primary" onclick="saveAccountSettings()">保存</button>
    </div>
  </div>
</div>

<!-- Admin panel modal -->
<div class="modal-overlay" id="modal-admin">
  <div class="modal" style="max-width:500px;">
    <h3><i class="fas fa-user-shield"></i> 管理者パネル</h3>
    <div class="section-title">承認待ちユーザー</div>
    <div id="admin-pending-users" style="max-height:300px;overflow-y:auto;">
      <!-- Dynamic list -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="closeModal('modal-admin')">閉じる</button>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close">&times;</button>
  <img id="lightbox-img" src="">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
<script src="/js/app.js"></script>
</body>
</html>
